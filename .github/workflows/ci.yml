# PocolVM GitHub Actions CI/CD

name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build posm
        working-directory: ./posm
        run: make
      
      - name: Build pm
        working-directory: ./pm
        run: make

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build
        run: make -C posm && make -C pm
      
      - name: Test assembler
        run: ./posm/posm example/3010.pcl -o /tmp/test.pob
      
      - name: Test VM
        run: ./pm/pm /tmp/test.pob

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y clang-format cppcheck
      
      - name: Check formatting
        run: |
          for f in pm/*.c pm/*.h posm/*.c posm/*.h; do
            [ -f "$f" ] && clang-format --style=file --dry-run -Werror "$f" || true
          done